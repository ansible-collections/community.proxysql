---
- name: "{{ role_name }} | test_delete_using_check_mode | set current test"
  set_fact:
    current_test: test_delete_using_check_mode

- include_tasks: base_test.yml

### then

- name: verify test against proxysql >= 2
  when: PROXYSQL2
  block:
    - name: "{{ role_name }} | {{ current_test }} | check if delete query rule in check mode reported a change"
      assert:
        that:
          - status is changed

    - name: "{{ role_name }} | {{ current_test }} | confirm delete query rule in check mode didn't make a change in memory"
      assert:
        that: memory_result.stdout == '{{ test_user }},{{ test_match_pattern }},{{ test_destination_hostgroup }},{{ test_active }},{{ test_retries }},{{ test_cache_ttl }},{{ test_cache_empty_result }},{{ test_multiplex }},{{ test_next_query_flagin }}'

    - name: "{{ role_name }} | {{ current_test }} | confirm delete query rule in check mode didn't make a change on disk"
      assert:
        that: disk_result.stdout == '{{ test_user }},{{ test_match_pattern }},{{ test_destination_hostgroup }},{{ test_active }},{{ test_retries }},{{ test_cache_ttl }},{{ test_cache_empty_result }},{{ test_multiplex }},{{ test_next_query_flagin }}'

    - name: "{{ role_name }} | {{ current_test }} | confirm delete query rule in check mode didn't make a change to runtime"
      assert:
        that: runtime_result.stdout == '{{ test_user }},{{ test_match_pattern }},{{ test_destination_hostgroup }},{{ test_active }},{{ test_retries }},{{ test_cache_ttl }},{{ test_cache_empty_result }},{{ test_multiplex }},{{ test_next_query_flagin }}'

- name: verify test against proxysql < 2
  when: not PROXYSQL2
  block:
    - name: "{{ role_name }} | {{ current_test }} | check if delete query rule in check mode reported a change"
      assert:
        that:
          - status1 is changed

    - name: "{{ role_name }} | {{ current_test }} | confirm delete query rule in check mode didn't make a change in memory"
      assert:
        that: memory_result1.stdout == '{{ test_user }},{{ test_match_pattern }},{{ test_destination_hostgroup }},{{ test_active }},{{ test_retries }},{{ test_cache_ttl }},{{ test_multiplex }},{{ test_next_query_flagin }}'

    - name: "{{ role_name }} | {{ current_test }} | confirm delete query rule in check mode didn't make a change on disk"
      assert:
        that: disk_result1.stdout == '{{ test_user }},{{ test_match_pattern }},{{ test_destination_hostgroup }},{{ test_active }},{{ test_retries }},{{ test_cache_ttl }},{{ test_multiplex }},{{ test_next_query_flagin }}'

    - name: "{{ role_name }} | {{ current_test }} | confirm delete query rule in check mode didn't make a change to runtime"
      assert:
        that: runtime_result1.stdout == '{{ test_user }},{{ test_match_pattern }},{{ test_destination_hostgroup }},{{ test_active }},{{ test_retries }},{{ test_cache_ttl }},{{ test_multiplex }},{{ test_next_query_flagin }}'

### perform cleanup

- name: "{{ role_name }} | {{ current_test }} | ensure we're in a clean state when we finish"
  import_tasks: cleanup_test_query_rules.yml
